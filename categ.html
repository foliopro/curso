<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Categorías - canomdigital</title>

<style>
:root {
  --bg: linear-gradient(135deg,#060818,#111827,#1f2937);
  --card-bg: rgba(15,23,42,0.92);
  --text-main: #e5e7eb;
  --text-muted: #9ca3af;
  --accent: #38bdf8;
  --border-soft: rgba(148,163,184,0.25);
}

.light {
  --bg: #ffffff;
  --card-bg: #ffffff;
  --text-main: #1f2937;
  --text-muted: #4b5563;
  --accent: #2563eb;
  --border-soft: rgba(0,0,0,0.2);
}

body {
  margin: 0;
  background: var(--bg);
  font-family: system-ui,sans-serif;
  color: var(--text-main);
  min-height: 100vh;
  transition: 0.3s ease;
}

/* HEADER */
header {
  text-align: center;
  padding: 28px 10px 10px;
}

.header-logo-row {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 12px;
}

.header-logo {
  width: 50px;
  height: 50px;
  border-radius: 14px;
  overflow: hidden;
  border: 1px solid var(--border-soft);
}

.header-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.header-title {
  font-size: 22px;
  font-weight: 600;
}

.header-sub {
  font-size: 22px;
  font-weight: 600;
  color: var(--text-muted);
  margin-top: 4px;
}

/* MENU */
.menu-bar {
  display: flex;
  justify-content: center;
  gap: 22px;
  margin-top: 14px;
}

.menu-btn {
  font-size: 14px;
  cursor: pointer;
  padding: 6px 12px;
  border-radius: 8px;
}

.menu-btn:hover {
  background: rgba(255,255,255,0.1);
}

#userNameLabel {
  color: var(--accent);
  font-weight: 600;
}

/* BANNER DEL CURSO */
.course-banner {
  max-width: 1080px;
  margin: 20px auto 10px;
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--card-bg);
  border-radius: 18px;
  border: 1px solid var(--border-soft);
  padding: 14px 18px;
  box-shadow: 0 10px 26px rgba(0,0,0,0.35);
}

.course-banner img {
  width: 72px;
  height: 72px;
  border-radius: 16px;
  object-fit: cover;
}

.course-banner-title {
  font-size: 20px;
  font-weight: 600;
}

.course-banner-sub {
  font-size: 14px;
  color: var(--text-muted);
}

/* CONTENEDOR DE CARDS */
#msg {
  padding: 10px 24px;
  text-align: center;
  font-size: 18px;
}

.container {
  padding: 10px 24px 50px;
  max-width: 1080px;
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
  gap: 26px;
}

/* CARD */
.card {
  background: var(--card-bg);
  border-radius: 18px;
  overflow: hidden;
  border: 1px solid var(--border-soft);
  box-shadow: 0 10px 28px rgba(0,0,0,0.35);
  transition: 0.25s ease;
  cursor: pointer;

  opacity: 0;
  animation: fadeUp 0.6s ease forwards;
}

@keyframes fadeUp {
  from { opacity:0; transform: translateY(15px); }
  to   { opacity:1; transform: translateY(0); }
}

.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 16px 40px rgba(0,0,0,0.45);
}

.card img {
  width: 100%;
  height: 160px;
  object-fit: cover;
  transition: transform 0.4s ease;
}

.card:hover img {
  transform: scale(1.06);
}

.card-body {
  padding: 20px;
}

.card-title {
  font-size: 18px;
  font-weight: 600;
  text-align: center;
}

.card-desc {
  font-size: 14px;
  color: var(--text-muted);
  text-align: center;
  margin-top: 6px;
}
</style>
</head>
<body>

<header>
  <div class="header-logo-row">
      <div class="header-logo">
          <img src="https://i.ibb.co/SwLDkhWg/Logo-CMD.jpg">
      </div>
      <div class="header-title">canomdigital</div>
  </div>

  <div class="header-sub">Plataforma de Cursos Digitales</div>

  <div class="menu-bar">
      <div class="menu-btn" onclick="goHome()">Inicio</div>
      <div class="menu-btn" onclick="goBack()">Atrás</div>
      <div id="temaBtn" class="menu-btn">Tema</div>
      <div class="menu-btn" onclick="logout()">Cerrar sesión</div>
      <div class="menu-btn" id="userNameLabel"></div>
  </div>
</header>

<div class="course-banner" id="courseBanner" style="display:none;">
  <img id="courseImage" src="">
  <div>
    <div class="course-banner-title" id="courseTitle"></div>
    <div class="course-banner-sub">Categorías disponibles para este curso</div>
  </div>
</div>

<div id="msg">Cargando categorías...</div>
<div class="container" id="categoryContainer"></div>

<script>
const URL_CURSOS_CONT =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQM-3mBbdkaK-jDv6DVdQd0VkehUZie71C5McD_djtCiN8GVSLA2ERqlQvmd17-o4ZZQB1Qrs1QXVGU/pub?output=csv";

/* Validación básica */
if(!localStorage.getItem("usuario")){
  window.location.href = "index.html";
}

/* Mostrar nombre de usuario */
document.getElementById("userNameLabel").textContent =
  localStorage.getItem("usuario_nombre") || "";

/* Navegación */
function goHome(){ window.location.href = "cursos.html"; }
function goBack(){ window.location.href = "cursos.html"; }

function logout(){
  localStorage.clear();
  window.location.href = "index.html";
}

/* Tema */
function aplicarTema(){
  const t = localStorage.getItem("tema") || "dark";
  document.body.classList.toggle("light", t==="light");
}
document.getElementById("temaBtn").onclick = () => {
  const now = (localStorage.getItem("tema")||"dark")==="dark" ? "light" : "dark";
  localStorage.setItem("tema",now);
  aplicarTema();
};
aplicarTema();

/* CSV parser robusto */
function parseCSV(t){
  return t.split("\n")
          .map(r=>r.replace(/\r/g,"").trim())
          .filter(r=>r.length)
          .map(r=>r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
}

/* Cargar categorías */
async function cargarCategorias(){
  const cursoCod = localStorage.getItem("curso_cod");
  const cursoTitulo = localStorage.getItem("curso_titulo");
  const cursoImagen = localStorage.getItem("curso_imagen");

  if(!cursoCod){
    // Si no hay curso seleccionado, volvemos a cursos
    window.location.href = "cursos.html";
    return;
  }

  // Banner del curso
  const banner = document.getElementById("courseBanner");
  const img = document.getElementById("courseImage");
  const title = document.getElementById("courseTitle");

  img.src = cursoImagen || "";
  title.textContent = cursoTitulo || "";
  banner.style.display = "flex";

  const txt = await (await fetch(URL_CURSOS_CONT)).text();
  const rows = parseCSV(txt);
  rows.shift(); // encabezados

  const cont = document.getElementById("categoryContainer");
  const msg = document.getElementById("msg");

  // Filtrar categorías: mismo curso, Sub vacío, Estado A
  const categorias = rows.filter(r =>
    r[0] === cursoCod &&           // CodCurso
    (r[2] || "").trim() === "" &&  // Sub vacío
    (r[8] || "").trim() === "A"    // Estado A (columna 9)
  );

  if(!categorias.length){
    msg.textContent = "Este curso aún no tiene categorías configuradas.";
    return;
  }

  msg.style.display = "none";
  cont.innerHTML = "";

  categorias.forEach(cat => {
    const catCod   = cat[1]; // Cat
    const titulo   = cat[3]; // Tit
    const desc     = cat[4]; // Desc
    const detalle  = cat[5]; // Detalle (no usado aquí)
    const imgUrl   = cat[6]; // Imagen
    const link     = (cat[7] || "").trim(); // Link

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <img src="${imgUrl}" alt="${titulo}">
      <div class="card-body">
        <div class="card-title">${titulo}</div>
        <div class="card-desc">${desc}</div>
      </div>
    `;

    card.onclick = () => {
      // Guardar info de la categoría
      localStorage.setItem("cat_cod", catCod);
      localStorage.setItem("cat_titulo", titulo);
      localStorage.setItem("cat_desc", desc);
      localStorage.setItem("cat_imagen", imgUrl);

      // Si tiene link -> ir directo al link (atajo)
      if(link){
        window.location.href = link;
        return;
      }

      // Si NO tiene link -> ir a leccion.html
      window.location.href = "leccion.html";
    };

    cont.appendChild(card);
  });
}

cargarCategorias();
</script>

</body>
</html>
